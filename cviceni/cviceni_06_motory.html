<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Řízení motorů - BPC-PRP</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../title-page.html">Uvod</a></li><li class="chapter-item expanded affix "><a href="../prednasky.html">Přednášky</a></li><li class="chapter-item expanded affix "><a href="../cviceni.html">Cvičení</a></li><li class="chapter-item expanded "><a href="../chap_1_software/text/intro.html"><strong aria-hidden="true">1.</strong> Softwarové vybavení</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../chap_1_software/text/linux.html"><strong aria-hidden="true">1.1.</strong> Linux a příkazová řádka</a></li><li class="chapter-item expanded "><a href="../chap_1_software/text/git.html"><strong aria-hidden="true">1.2.</strong> Git - Verzovací systému</a></li><li class="chapter-item expanded "><a href="../chap_1_software/text/clion.html"><strong aria-hidden="true">1.3.</strong> CLion IDE</a></li><li class="chapter-item expanded "><a href="../chap_1_software/text/ros.html"><strong aria-hidden="true">1.4.</strong> Robotic Operating System</a></li><li class="chapter-item expanded "><a href="../chap_1_software/text/vb.linux_installation.html"><strong aria-hidden="true">1.5.</strong> Příprava prostředí</a></li></ol></li><li class="chapter-item expanded "><a href="../simulator/intro.html"><strong aria-hidden="true">2.</strong> Simulátor</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../simulator/rozhrani.html"><strong aria-hidden="true">2.1.</strong> Rozhraní</a></li><li class="chapter-item expanded "><a href="../simulator/nmea.html"><strong aria-hidden="true">2.2.</strong> Program nmea</a></li><li class="chapter-item expanded "><a href="../simulator/robot.html"><strong aria-hidden="true">2.3.</strong> Program robot</a></li></ol></li><li class="chapter-item expanded "><a href="../cviceni/cviceni_uvod.html"><strong aria-hidden="true">3.</strong> Cviceni</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../cviceni/cviceni_01_linux_install.html"><strong aria-hidden="true">3.1.</strong> Instalace a seznámení se s prostředím</a></li><li class="chapter-item expanded "><a href="../cviceni/cviceni_02_linux_cli_cpp.html"><strong aria-hidden="true">3.2.</strong> Linux CLI a C++</a></li><li class="chapter-item expanded "><a href="../cviceni/cviceni_03_git.html"><strong aria-hidden="true">3.3.</strong> GIT, simulátor</a></li><li class="chapter-item expanded "><a href="../cviceni/cviceni_04_udp.html"><strong aria-hidden="true">3.4.</strong> UDP komunikace</a></li><li class="chapter-item expanded "><a href="../cviceni/cviceni_05_i2c.html"><strong aria-hidden="true">3.5.</strong> Hardware, I2C, ADC</a></li><li class="chapter-item expanded "><a href="../cviceni/cviceni_06_motory.html" class="active"><strong aria-hidden="true">3.6.</strong> Řízení motorů</a></li><li class="chapter-item expanded "><a href="../cviceni/cviceni_07_snimac_cary.html"><strong aria-hidden="true">3.7.</strong> Snímání čáry</a></li><li class="chapter-item expanded "><a href="../cviceni/cviceni_09_regulator.html"><strong aria-hidden="true">3.8.</strong> Návrh regulátoru</a></li><li class="chapter-item expanded "><a href="../cviceni/cviceni_10_telemetrie_vizualizace.html"><strong aria-hidden="true">3.9.</strong> Telemetrie a vizualizace</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">BPC-PRP</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#Řízení-motorů" id="Řízení-motorů">Řízení motorů</a></h1>
<p>Cvičící: Ing. František Burian  Ph.D.</p>
<h2><a class="header" href="#cile" id="cile">Cile</a></h2>
<ul>
<li>Vyzkoušet chování reálného krokového motoru v reálných podmínkách</li>
<li>Rozpohybovat kola simulovaného robota tak, aby bylo možné řidit jeho pohyb pomocí kinematiky.</li>
<li>Zprovoznit čtení ujeté dráhy jednotlivých motorů.</li>
</ul>
<h2><a class="header" href="#prerekvizity" id="prerekvizity">Prerekvizity</a></h2>
<ul>
<li>Pro HW část funkční hardware</li>
<li>Funkční komunikace se simulátorem (ověřit pomocí zprávy <code>PING</code>)</li>
<li>Funkční parsování NMEA řetězců</li>
</ul>
<h2><a class="header" href="#komunikace-s-reálným-budičem-krokového-motoru" id="komunikace-s-reálným-budičem-krokového-motoru">Komunikace s reálným budičem krokového motoru</a></h2>
<h3><a class="header" href="#Řetězec-řízení" id="Řetězec-řízení">Řetězec řízení</a></h3>
<p>Raspberry -- I2C -- interpolátor -- budič -- motor -- převodovka -- kolo</p>
<h3><a class="header" href="#příklad-komunikace-s-krokovým-motorem" id="příklad-komunikace-s-krokovým-motorem">Příklad komunikace s krokovým motorem</a></h3>
<p>Vraťte se k programu z předchozího cvičení, založte novou větev &quot;hw-cv6-km2&quot; na původním masteru a vložte tento kód:</p>
<pre><code class="language-cpp">  using namespace RoboUtils;

  const auto LBUT = Pin::PA7;
  const auto RBUT = Pin::PA6;

  int main()
  {
    I2C i2c{&quot;/dev/i2c-3&quot;};
    GPIO gpio{&amp;i2c};
    KM2 km2{&amp;i2c};

    gpio.input(LBUT | RBUT, true);

    int spdl = 2, spdr = 2; // 2 mikrokroky za 1/40kHz

    while (true) {
      delay(50);                        // zajisteni periody smycky
      auto [ left, right] = km2.driveodo(spdl,spdr);

      // zde pracujte s odometrií a hodnotami rychlosti motoru

    }

    // dobra aplikace po sobe na konci uklidi
    km2.drive(0,0);
  }
</code></pre>
<p>COMMIT / PUSH</p>
<p>Program spusťte, motor by se měl pomalu roztočit. Prozkoumejte API knihovny jakým způsobem to je provedeno.</p>
<h3><a class="header" href="#motor-připojený-ke-kolu---metrický-popis-jednotek" id="motor-připojený-ke-kolu---metrický-popis-jednotek">Motor připojený ke kolu - metrický popis jednotek</a></h3>
<p>Krokový motor se s každým impulzem na vinutích posunuje o 1 krok (step). Tyto kroky je možné rozdělit na menší části, mikrokroky.</p>
<p>✅ Počet kroků na otáčku je vlastností daného krokového motoru. Mikrokrok a množství jeho úrovní je vlastností použitého budiče motorů.</p>
<p>✅ Z katalogového listu motoru byste zjistili, že rozměr kroku je 1.8°, na plnou otáčku tedy připadá kolik kroků?</p>
<details>
    <summary>Odpověď</summary>
    360 / 1.8 = 200
</details>
<p>✅ Zadaný budič motorů rozdělí krok do 32 mikrokroků, kolik mikrokroků připadá na celou otáčku?</p>
<details>
    <summary>Odpověď</summary>
    200 * 32 = 6400
</details>
<br/><br/>
<p>Pokud řídíme reálné fyzikální systémy je vhodné programovat pomocí reálných fyzikálních jednotek a vždy to dodržovat, nestane se, že nebudeme vědět jaký rozměr má nějaká proměnná.</p>
<p>Pro řízení motoru je vhodná úhlová rychlost zadaná v otáčkách za sekundu a tuto rychlost převeďte mikrokroky za sekundu.</p>
<details>
    <summary>Odpověď</summary>
    speedInMicrosteps = targetSpeed * microstepsPerRevolution
</details>
<p>Naopak, pro popis odometrie, tj ujeté vzdálenosti kolem je vhodné popsat veličinu v jednotkách SI tedy metrech. To samozřejmě ovlivňuje průměr (respektive obvod) kola. Jak to provedeme?</p>
<details>
    <summary>Odpověď</summary>
    targetPosition = positionInMicrosteps * wheelCircumference / microstepsPerRevolution
</details>
<h3><a class="header" href="#zjištění-maximálních-rychlostí-reálného-motoru" id="zjištění-maximálních-rychlostí-reálného-motoru">Zjištění maximálních rychlostí reálného motoru</a></h3>
<p>Upravte program v příkladu tak, abyste mohli pomocí tlačítek PB6 a PB7 přidávat a ubírat rychlost, kterou posílá do motorů. Sledujte vliv 
této rychlosti na napájecím proudu obou motorů (zdroj DIAMETRAL, měření proudu).</p>
<details>
    <summary>Pozorování</summary>
    Proud, tedy výkon dodávaný do zátěže od určité rychlosti začne klesat !
</details>
<p>COMMIT / PUSH</p>
<p>Vysvětlete pozorované chování a zhodnoťte důsledky pro řízení takovéhoto motoru</p>
<details>
    <summary>Odpověď</summary>
    V určitých otáčkách již nevyvineme sílu na pokračování otáčení motorem a motor se zastaví. 
</details>
<p>Upravte program tak, aby se po stisknutí tlačítka motor rozjel na rychlosti, při které byl naměřen <strong>poloviční</strong> proud v předchozím experimentu. 
Zkuste zatěžovat (prstem) motor, a pozorujte chování. Zkuste totéž při rychlosti, při které byl proud naměřený na diametralu <strong>maximální</strong>. 
Pozorujte chování a zhodnoťte pozorování.</p>
<details>
    <summary>Odpověď</summary>
    Při nejvyšším příkonu můžeme vyvinout nejvyšší sílu. Sílu temelínu najdeme v hermelínu. Čím vyšší bude mít robot hmotnost, tím více zatěžujeme motory a tím menší zrychlení utáhne. Problém lze obejít snížením síly potřebné pro otáčení - tj snížením zrychlení.
</details>
<p>COMMIT / PUSH</p>
<h3><a class="header" href="#rampový-generátor" id="rampový-generátor">Rampový generátor</a></h3>
<p>Snížení zrychlení lze realizovat různými způsoby (například interpolací po S-křivce). Jednodušší variantou je interpolace po obyčejné rychlostní<br />
(někdy též zvané trapézoidní) rampě, která je mnohem jednodušší.</p>
<p>✅ Algoritmus: V každém kroku řízení k momentální rychlosti motoru přičteme požadovanou diferenci rychlosti se stejným znaménkem jako má rozdíl <code>požadovaná rychlost - momentální rychlost</code>. Tuto diferenci však saturujeme na maximálních hodnotách.</p>
<p><img src="../images/ramp_gen.jpg" alt="Generator Ramp" /></p>
<p>Generátor rampy, který běží periodicky, efektivně řeší problém s opakováním řídicích zpráv pro motory, stačí periodicky získávat novou hodnotu rychlosti z generátoru ramp a tu posílat budiči motoru (simulátoru).</p>
<p>Upravte program tak, aby se po stisknutí tlačítka motor rozjel na hodnotu rychlosti, při které byl naměřen <strong>poloviční</strong> proud v předchozím experimentu a porovnejte výsledky s předchozím měřením</p>
<details>
    <summary>Pozorování</summary>
    Motor se snížením rampy lze zatížit více a tím pádem dosáhnout vyšší rychlosti bez zastavení. Čím pomalejší rampa je, tím více síly motoru zbyde pro udržení rychlosti, ale reakce motoru se notně zpomalí.
</details>
<p>COMMIT / PUSH</p>
<h2><a class="header" href="#nmea-protokol" id="nmea-protokol">NMEA protokol</a></h2>
<p>Otevřete si projekt z minulého / předminulého cvičení, kde jste zpracovávali NMEA protokol. Následující body již nemusíte tvořit na cvičení, lze je realizovat i v simulátoru.</p>
<p>V tomto cvičení již budete ovládat robota pomocí NMEA zpráv, je tedy nutné pravidelně navracet simulátor do výchozího stavu.
Toho lze dosáhnout jak opětovným spuštěním jak simulátoru, tak vašeho programu, lze to ale řešit přímočařeji, a to tak,
že při startu vašeho programu simulátoru pošlete NMEA zprávu <a href="./../simulator/rozhrani.html#reset">RESET</a>.</p>
<p>✅ Po odeslání resetu byste měli přijmout NMEA zprávu <code>$RESET,DONE</code>.</p>
<p>Pakliže nepřijmete DONE, program ukončete s chybou.</p>
<p>Simulátor simuluje chování dvou krokových motorů, na které jsou namonotována kola uživatelsky definovaného průměru.
Motory jsou řízeny pomocí NMEA zpráv <a href="./../simulator/rozhrani.html#speed">SPEED</a> a <a href="./../simulator/rozhrani.html#odo">ODO</a> posílaných simulátoru.</p>
<h3><a class="header" href="#nastavení-rychlosti-kol" id="nastavení-rychlosti-kol">Nastavení rychlosti kol</a></h3>
<p>Příkaz pro nastavení rychlosti motoru je <a href="./../simulator/rozhrani.html#speed">SPEED</a>. Pošleme tedy tento příkaz simulátoru s nějakou malou 
rychlostí levého kola, třeba 0.05 otáčky za sekundu a nulovou rychlostí pravého kola.</p>
<p>✅ Pokud nám vše správně funguje, měl by se robot v simulátoru začít pomalu otáčet.</p>
<p>Motor se po asi 1 s otáčení zastaví, toto je bezpečnostní funkce, která je implementována v našich reálných budičích motorů. V případě softwarové chyby, kdy by spadl řídicí program, by se totiž robot mohl nekontrolovatelně rozjet.
Je tedy nutné řídicí příkazy posílat periodicky.</p>
<p>✅ Pokuste se najít maximální rychlost, které jste schopni v simulátoru bez rampy dosáhnout.</p>
<p>COMMIT / PUSH</p>
<h3><a class="header" href="#Čtení-ujeté-vzdálenosti" id="Čtení-ujeté-vzdálenosti">Čtení ujeté vzdálenosti</a></h3>
<p>Pro lokalizaci robota v prostředí lze využít výpočtu odometrie z ujeté vzdálenosti obou kol, to bude předmětem dalších cvičení, je ale vhodné
si to již teď připravit. Čtení ujeté vzdálenost je v simulátoru implementováno pomocí příkazu <a href="./../simulator/rozhrani.html#odo">ODO</a>. Tento příkaz 
způsobí, že nám simulátor pošle ujetou vzdálenost v mikrokrocích pro obě kola a sám si vnitřní hodnotu ujeté vzdálenosti vynuluje.</p>
<p>✅ Vyzkoušejte si čtení ujeté vzdálenosti obou motorů a jejich přepočet na ujeté metry.</p>
<p>✅ Vyzkoušejte si, že se hodnota ujeté vzdálenosti opravdu nuluje.</p>
<h2><a class="header" href="#očekávané-výstupy-práce-v-tomto-cvičení" id="očekávané-výstupy-práce-v-tomto-cvičení">Očekávané výstupy práce v tomto cvičení</a></h2>
<p>✅ Jste schopni ovládat oba motory simulovaného robota v plném rozsahu rychlostí.</p>
<p>✅ Máte naimplementováno generování ramp pro oba motory.</p>
<p>✅ Jste schopni ze simulátoru získávat data o ujeté vzdálenosti pro oba motory.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../cviceni/cviceni_05_i2c.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../cviceni/cviceni_07_snimac_cary.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../cviceni/cviceni_05_i2c.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../cviceni/cviceni_07_snimac_cary.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
